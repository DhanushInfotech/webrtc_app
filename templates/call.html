<html>
    <head>
        <title>Caller</title>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
         <meta charset="utf-8" />
         <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
         <style>
                 audio, video {
                        -moz-transition: all 1s ease;
                        -ms-transition: all 1s ease;

                        -o-transition: all 1s ease;
                        -webkit-transition: all 1s ease;
                        transition: all 1s ease;
                        vertical-align: top;
                    }

             </style>
			<script src="static/rtc-lib/PeerConnection.js"> </script>
            <script src="static/rtc-lib/web_socket.js"> </script>
    </head>
    <body>
        <section class="videos">
            <table id="videos-container">
                <tr>
                    <td id="me-cont">

                    </td>
                    <td id="you-cont">

                    </td>
                </tr>
            </table>
        </section>

        <script>
            var websocket = new WebSocket('{% raw caller_ws_uri %}');

            websocket.onerror = function() {
                //location.reload();
            };

            websocket.onclose = function() {
                <!--window.close();-->
            };

            websocket.push = websocket.send;
            websocket.send = function(data) {
                websocket.push(JSON.stringify(data));
            };


            var peer = new PeerConnection(websocket);
            meCont = document.getElementById('me-cont') || document.body;
            youCont = document.getElementById('you-cont');
            meVideo = undefined;
            youVideo = undefined;
            peer.onUserFound = function(userid) {
                if(meVideo)
                {
                    if(youVideo)
                        return;
                    getUserMedia(function(stream) {
                                     peer.addStream(stream);
                                     peer.sendParticipationRequest(user_id);
                                     },
                                     youCont);
                }
            };

            peer.onStreamAdded = function(e) {
                var video = e.mediaElement;
                if(!video.src)
                    return;
                video.setAttribute('width', 600);
                video.setAttribute('controls', true);

                if(e.video_container == undefined)
                {
                        video.id = youCont.id + 'Video';
                        youCont.appendChild(video);
                }
                else
                {
                    video.id = e.video_container.id+'Video';
                    e.video_container.appendChild(video);
                }
                video.play();
                scaleVideos();
            };

            peer.onStreamEnded = function(e) {
                var video = e.mediaElement;
                if (video) {
                    video.style.opacity = 0;
                    setTimeout(function() {
                               video.parentNode.removeChild(video);
                               scaleVideos();
                               }, 1000);
                }
            };


            function scaleVideos() {
                var windowWidth = window.innerWidth
                        || document.documentElement.clientWidth
                        || document.body.clientWidth;

                meVideo = document.getElementById(meCont.id+'Video');
                youVideo = document.getElementById(youCont.id+'Video');
                if(youVideo)
                    youVideo.width = windowWidth*0.7;
                if(meVideo)
                    meVideo.width = windowWidth*0.7;
                if(youVideo && meVideo)
                    meVideo.width = windowWidth*0.2;
            }

            window.onresize = scaleVideos;

            // you need to capture getUserMedia yourself!
            function getUserMedia(callback, video_container) {
                var hints = {
                    audio: true,
                    video: {
                        optional: [],
                        mandatory: {}
                    }
                };
                navigator.getUserMedia(hints, function(stream) {
                                       var video = document.createElement('video');
                                       video.src = URL.createObjectURL(stream);
                                       video.controls = true;
                                       video.muted = true;

                                       peer.onStreamAdded({
                                                          mediaElement: video,
                                                          userid: 'self',
                                                          stream: stream,
                                                          video_container: video_container
                                                          });

                                       callback(stream);
                                       });
            }

        (function() {
         var callerid = '{{caller_id}}';
         if(callerid) {
            getUserMedia(function(stream) {
                         peer.addStream(stream);
                         peer.startBroadcasting();
                         }, meCont);
            peer.userid = callerid;
         }

         })();
            </script>

    </body>

</html>